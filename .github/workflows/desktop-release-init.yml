name: Desktop Release - Initialize

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major
      web_release_tag:
        description: 'Web release tag to branch from (e.g. v2025-01-05)'
        required: true
        type: string
      release_notes_url:
        description: 'Draft release notes URL (Notion link)'
        required: true
        type: string
      release_description:
        description: 'Brief release description'
        required: false
        type: string
        default: 'Bug fixes and improvements'

permissions:
  contents: write
  actions: write

concurrency:
  group: desktop-release-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  validate-and-calculate:
    name: Validate & Calculate Version
    runs-on: ubuntu-latest
    outputs:
      base_branch: ${{ github.ref_name }}
      current_version: ${{ steps.version.outputs.current }}
      new_version: ${{ steps.version.outputs.new }}
      release_date: ${{ steps.version.outputs.date }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Calculate new version
        id: version
        run: |
          CURRENT=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          case "${{ inputs.bump_type }}" in
            major) NEW="$((MAJOR + 1)).0.0" ;;
            minor) NEW="${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEW="${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac
          
          echo "new=$NEW" >> $GITHUB_OUTPUT
          echo "date=$(date +'%d/%m/%Y')" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $CURRENT ‚Üí $NEW"

      - name: Check if release branch already exists
        run: |
          BRANCH="desktop/release-${{ steps.version.outputs.new }}"
          if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
            echo "‚ùå Branch '$BRANCH' already exists!"
            exit 1
          fi

  create-branch-and-bump:
    name: Create Branch & Bump Version
    needs: validate-and-calculate
    runs-on: ubuntu-latest
    outputs:
      release_branch: ${{ steps.create.outputs.branch }}
    env:
      NEW_VERSION: ${{ needs.validate-and-calculate.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create release branch and bump version
        id: create
        run: |
          BRANCH="desktop/release-${NEW_VERSION}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          git checkout -b "$BRANCH"
          
          for file in src-tauri/tauri.conf.json src-tauri/tauri.conf.staging.json src-tauri/tauri.conf.production.json; do
            [ -f "$file" ] && jq --arg v "$NEW_VERSION" '.version = $v' "$file" > tmp.json && mv tmp.json "$file"
          done
          
          git add -A
          git commit -m "chore: bump version to ${NEW_VERSION}"
          git push origin "$BRANCH"

      - name: Summary
        env:
          CURRENT_VERSION: ${{ needs.validate-and-calculate.outputs.current_version }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        run: |
          echo "## üöÄ Desktop Release ${NEW_VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${CURRENT_VERSION}\` ‚Üí \`${NEW_VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | [\`desktop/release-${NEW_VERSION}\`](${REPO_URL}/tree/desktop/release-${NEW_VERSION}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Description | ${{ inputs.release_description }} |" >> $GITHUB_STEP_SUMMARY

  notify-slack-init:
    name: Notify Slack (Release Created)
    needs: [validate-and-calculate, create-branch-and-bump]
    runs-on: ubuntu-latest
    env:
      NEW_VERSION: ${{ needs.validate-and-calculate.outputs.new_version }}
      CURRENT_VERSION: ${{ needs.validate-and-calculate.outputs.current_version }}
      REPO_URL: ${{ github.server_url }}/${{ github.repository }}
      WEB_RELEASE_TAG: ${{ inputs.web_release_tag }}
      RELEASE_NOTES_URL: ${{ inputs.release_notes_url }}
      RELEASE_DESC: ${{ inputs.release_description }}
    steps:
      - name: Send Slack notification
        run: |
          CHANNELS="${{ secrets.SLACK_DESKTOP_RELEASE_CHANNEL_INTERNAL }}"
          IFS=',' read -ra CHANNEL_ARRAY <<< "$CHANNELS"
          
          for CHANNEL in "${CHANNEL_ARRAY[@]}"; do
            cat > /tmp/slack_payload.json << EOF
          {
            "channel": "$CHANNEL",
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "üö® Desktop App v$NEW_VERSION Release Created", "emoji": true }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "Hey Team! üëã\n\nI've branched off a new release branch for desktop app:\n\n‚Ä¢ *Release Branch:* \`desktop/release-$NEW_VERSION\`\n‚Ä¢ *Based on Web Release:* \`$WEB_RELEASE_TAG\`\n‚Ä¢ *Version:* \`$CURRENT_VERSION\` ‚Üí \`$NEW_VERSION\`\n\nüìù *Changes:* $RELEASE_DESC\n\n*@product* Could you please help review the draft release note?"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "‚ö†Ô∏è *Please NOTE:*\n‚Ä¢ Any critical bug fixes to \`main\` branch must be cherry-picked to this release branch\n‚Ä¢ We will release once testing is complete"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "üîß *Need to include your fix?*\n\`\`\`git fetch origin\ngit checkout -b my-fix desktop/release-$NEW_VERSION\ngit cherry-pick <commit-sha>\ngit push origin my-fix\`\`\`"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "üìÇ View Release Branch", "emoji": true },
                    "url": "$REPO_URL/tree/desktop/release-$NEW_VERSION"
                  },
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "üè∑Ô∏è View Web Release", "emoji": true },
                    "url": "$REPO_URL/releases/tag/$WEB_RELEASE_TAG"
                  },
                  {
                    "type": "button",
                    "text": { "type": "plain_text", "text": "üìã Draft Release Notes", "emoji": true },
                    "style": "primary",
                    "url": "$RELEASE_NOTES_URL"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  { "type": "mrkdwn", "text": "‚è≥ Builds will start after approval ‚Ä¢ <$REPO_URL/actions/runs/${{ github.run_id }}|View Workflow>" }
                ]
              }
            ]
          }
          EOF
            curl -X POST https://slack.com/api/chat.postMessage \
              -H "Authorization: Bearer ${{ secrets.SLACK_DESKTOP_RELEASE_BOT_TOKEN }}" \
              -H "Content-type: application/json" \
              --data @/tmp/slack_payload.json
          done

  # ============================================
  # üî® STAGING BUILD
  # ============================================
  build-staging:
    name: üî® Build Staging
    needs: [validate-and-calculate, create-branch-and-bump, notify-slack-init]
    uses: ./.github/workflows/desktop-app-publish-staging.yml
    secrets: inherit

  notify-staging-complete:
    name: Notify Staging Complete
    needs: [validate-and-calculate, build-staging]
    if: needs.build-staging.result == 'success'
    runs-on: ubuntu-latest
    env:
      NEW_VERSION: ${{ needs.validate-and-calculate.outputs.new_version }}
    steps:
      - name: Send Slack notification
        run: |
          CHANNELS="${{ secrets.SLACK_DESKTOP_RELEASE_CHANNEL_INTERNAL }}"
          MESSAGE="‚úÖ *Desktop App v$NEW_VERSION* - Staging build successful!\nüì• <https://web.crabnebula.cloud/heidi-scribe/scribe-staging|Download Staging Installer>"
          
          IFS=',' read -ra CHANNEL_ARRAY <<< "$CHANNELS"
          for CHANNEL in "${CHANNEL_ARRAY[@]}"; do
            curl -X POST https://slack.com/api/chat.postMessage \
              -H "Authorization: Bearer ${{ secrets.SLACK_DESKTOP_RELEASE_BOT_TOKEN }}" \
              -H "Content-type: application/json" \
              --data "{\"channel\":\"$CHANNEL\",\"text\":\"$MESSAGE\"}"
          done

  # ============================================
  # üöÄ PRODUCTION BUILD
  # ============================================
  build-production:
    name: üöÄ Build Production
    needs: [validate-and-calculate, create-branch-and-bump, notify-slack-init]
    uses: ./.github/workflows/desktop-app-publish-production.yml
    secrets: inherit

  notify-production-complete:
    name: Notify Production Complete
    needs: [validate-and-calculate, build-production]
    if: needs.build-production.result == 'success'
    runs-on: ubuntu-latest
    env:
      NEW_VERSION: ${{ needs.validate-and-calculate.outputs.new_version }}
      RELEASE_DATE: ${{ needs.validate-and-calculate.outputs.release_date }}
      RELEASE_DESC: ${{ inputs.release_description }}
      RELEASE_NOTES_URL: ${{ inputs.release_notes_url }}
    steps:
      - name: Send Slack notification
        run: |
          NOTES_LINK=""
          if [ -n "$RELEASE_NOTES_URL" ]; then
            NOTES_LINK="\n\nüìã <$RELEASE_NOTES_URL|View full release notes>"
          fi
          
          CHANNELS="${{ secrets.SLACK_DESKTOP_RELEASE_CHANNEL_PUBLIC }}"
          IFS=',' read -ra CHANNEL_ARRAY <<< "$CHANNELS"
          
          for CHANNEL in "${CHANNEL_ARRAY[@]}"; do
            cat > /tmp/slack_payload.json << EOF
          {
            "channel": "$CHANNEL",
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "üöÄ Desktop App Release v$NEW_VERSION - $RELEASE_DATE üöÄ", "emoji": true }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "We're excited to announce that Desktop App *v$NEW_VERSION* has just been released! üéâ\n\n$RELEASE_DESC$NOTES_LINK"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "üì• *Download:*\n‚Ä¢ <https://web.crabnebula.cloud/heidi-scribe/scribe|Production Installer>"
                }
              }
            ]
          }
          EOF
            curl -X POST https://slack.com/api/chat.postMessage \
              -H "Authorization: Bearer ${{ secrets.SLACK_DESKTOP_RELEASE_BOT_TOKEN }}" \
              -H "Content-type: application/json" \
              --data @/tmp/slack_payload.json
          done