name: Desktop Release - Initialize

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        default: 'patch'
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

concurrency:
  group: desktop-release-init
  cancel-in-progress: false

jobs:
  validate-and-calculate:
    name: Validate & Calculate Version
    runs-on: ubuntu-latest
    outputs:
      base_branch: ${{ github.ref_name }}
      current_version: ${{ steps.version.outputs.current }}
      new_version: ${{ steps.version.outputs.new }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Show base branch
        run: |
          echo "üìå Base branch: ${{ github.ref_name }}"

      - name: Calculate new version
        id: version
        run: |
          # ‰ªé tauri.conf.json ËØªÂèñÂΩìÂâçÁâàÊú¨
          CURRENT=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "üì¶ Current version: $CURRENT"
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          # Ëß£ÊûêÁâàÊú¨Âè∑
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          # Ê†πÊçÆ bump type ËÆ°ÁÆóÊñ∞ÁâàÊú¨
          case "${{ inputs.bump_type }}" in
            major)
              NEW="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW="${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEW="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
          esac
          
          echo "üÜï New version: $NEW"
          echo "new=$NEW" >> $GITHUB_OUTPUT

      - name: Check if release branch already exists
        run: |
          NEW_VERSION="${{ steps.version.outputs.new }}"
          BRANCH="desktop/release-${NEW_VERSION}"
          if git ls-remote --exit-code --heads origin "$BRANCH" > /dev/null 2>&1; then
            echo "‚ùå Branch '$BRANCH' already exists!"
            echo "üí° Please delete the existing branch first or choose a different bump type."
            exit 1
          fi
          echo "‚úÖ Branch '$BRANCH' does not exist yet"

  create-branch-and-bump:
    name: Create Branch & Bump Version
    needs: validate-and-calculate
    runs-on: ubuntu-latest
    env:
      NEW_VERSION: ${{ needs.validate-and-calculate.outputs.new_version }}
      CURRENT_VERSION: ${{ needs.validate-and-calculate.outputs.current_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create release branch
        run: |
          BRANCH="desktop/release-${NEW_VERSION}"
          echo "üîÄ Creating branch '$BRANCH' from '${{ github.ref_name }}'..."
          git checkout -b "$BRANCH"

      - name: Bump version in tauri config files
        run: |
          echo "üìù Bumping version from $CURRENT_VERSION to $NEW_VERSION"
          
          # Êõ¥Êñ∞ÊâÄÊúâ tauri config Êñá‰ª∂
          for file in src-tauri/tauri.conf.json src-tauri/tauri.conf.staging.json src-tauri/tauri.conf.production.json; do
            if [ -f "$file" ]; then
              echo "  Updating $file..."
              jq --arg v "$NEW_VERSION" '.version = $v' "$file" > tmp.json && mv tmp.json "$file"
            else
              echo "  ‚ö†Ô∏è File not found: $file (skipping)"
            fi
          done
          
          echo "‚úÖ Version bumped in all config files"

      - name: Commit and push
        run: |
          BRANCH="desktop/release-${NEW_VERSION}"
          
          git add -A
          git commit -m "chore: bump version to ${NEW_VERSION}"
          git push origin "$BRANCH"
          
          echo "‚úÖ Branch '$BRANCH' created and pushed with version ${NEW_VERSION}"

      - name: Summary
        run: |
          echo "## üöÄ Desktop Release ${NEW_VERSION} Initialized" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version Bump | \`${CURRENT_VERSION}\` ‚Üí \`${NEW_VERSION}\` (${{ inputs.bump_type }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| New Branch | \`desktop/release-${NEW_VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Created By | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Files Updated" >> $GITHUB_STEP_SUMMARY
          echo "- \`src-tauri/tauri.conf.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`src-tauri/tauri.conf.staging.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`src-tauri/tauri.conf.production.json\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Cherry-pick your fixes to \`desktop/release-${NEW_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Create PR and get it reviewed" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge and trigger build" >> $GITHUB_STEP_SUMMARY

  notify-slack:
    name: Notify Slack
    needs: [validate-and-calculate, create-branch-and-bump]
    runs-on: ubuntu-latest
    env:
      CURRENT_VERSION: ${{ needs.validate-and-calculate.outputs.current_version }}
      NEW_VERSION: ${{ needs.validate-and-calculate.outputs.new_version }}
      BASE_BRANCH: ${{ github.ref_name }}
      REPO_URL: ${{ github.server_url }}/${{ github.repository }}
      ACTOR: ${{ github.actor }}
      BUMP_TYPE: ${{ inputs.bump_type }}
    steps:
      - name: Send Slack notification
        run: |
          # Ê†πÊçÆ bump type ÁîüÊàêÊèèËø∞
          case "$BUMP_TYPE" in
            major)
              BUMP_DESC="This is a *major version* with breaking changes or significant new features."
              ;;
            minor)
              BUMP_DESC="This is a *minor version* with new features and improvements."
              ;;
            patch)
              BUMP_DESC="This is a *patch version* for bug fixes and critical issues."
              ;;
          esac

          # ÊûÑÂª∫ JSON payload
          cat > /tmp/slack_payload.json << EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üöÄ Desktop App $NEW_VERSION Release Initiated",
                  "emoji": true
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "Hey team! üëã\n\nA new release branch has been created for Desktop App *$NEW_VERSION*.\n\n$BUMP_DESC"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*New Branch:*\n\`desktop/release-$NEW_VERSION\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Based On:*\n\`$BASE_BRANCH\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Version:*\n\`$CURRENT_VERSION\` ‚Üí \`$NEW_VERSION\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Created By:*\n$ACTOR"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "‚úÖ *Version already bumped* in \`tauri.conf*.json\` files."
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "üì¢ *Need to include your fix in this release?*\nCherry-pick your commits using the command below:"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "\`\`\`git fetch origin\ngit checkout -b my-fix desktop/release-$NEW_VERSION\ngit cherry-pick <commit-sha>\ngit push origin my-fix\`\`\`"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "üí° Then create a PR from \`my-fix\` ‚Üí \`desktop/release-$NEW_VERSION\`"
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üìÇ View Branch",
                      "emoji": true
                    },
                    "url": "$REPO_URL/tree/desktop/release-$NEW_VERSION"
                  }
                ]
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "üèóÔ∏è *Ready to build?* After cherry-picks are merged, trigger the build:"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üî® Build Staging",
                      "emoji": true
                    },
                    "style": "primary",
                    "url": "$REPO_URL/actions/workflows/desktop-app-publish-staging.yml"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üöÄ Build Production",
                      "emoji": true
                    },
                    "style": "danger",
                    "url": "$REPO_URL/actions/workflows/desktop-app-publish-production.yml"
                  }
                ]
              }
            ]
          }
          EOF

          # ÂèëÈÄÅÂà∞ Slack
          curl -X POST -H 'Content-type: application/json' \
            --data @/tmp/slack_payload.json \
            ${{ secrets.SLACK_WEBHOOK_URL }}
