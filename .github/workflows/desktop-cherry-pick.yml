name: Desktop Release - Cherry Pick

on:
  workflow_dispatch:
    inputs:
      commit_shas:
        description: 'Commit SHA(s) to cherry-pick (comma-separated for multiple)'
        required: true
        type: string
        # Example: abc1234 or abc1234,def5678,ghi9012

permissions:
  contents: write
  pull-requests: write

jobs:
  cherry-pick:
    name: Cherry Pick Commits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate target branch
        run: |
          BRANCH="${{ github.ref_name }}"
          if [[ ! "$BRANCH" =~ ^desktop/release- ]]; then
            echo "âŒ Please run this workflow from a desktop/release-* branch!"
            echo "   Current branch: $BRANCH"
            echo ""
            echo "ğŸ’¡ Go to Actions â†’ Cherry Pick â†’ Run workflow"
            echo "   Then select your target release branch from 'Use workflow from'"
            exit 1
          fi
          echo "âœ… Target branch: $BRANCH"

      - name: Create feature branch and cherry-pick
        id: cherry-pick
        run: |
          TARGET_BRANCH="${{ github.ref_name }}"
          COMMITS="${{ inputs.commit_shas }}"
          
          # ç”Ÿæˆå”¯ä¸€çš„ branch åç§°
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          FEATURE_BRANCH="cherry-pick/${TARGET_BRANCH#desktop/release-}/${TIMESTAMP}"
          
          echo "ğŸ”€ Creating branch: $FEATURE_BRANCH"
          git checkout -b "$FEATURE_BRANCH"
          
          # è·å– main åˆ†æ”¯ä»¥ä¾¿ cherry-pick
          git fetch origin main
          
          # Cherry-pick æ¯ä¸ª commit
          IFS=',' read -ra COMMIT_ARRAY <<< "$COMMITS"
          CHERRY_PICKED=""
          
          for SHA in "${COMMIT_ARRAY[@]}"; do
            # å»é™¤ç©ºæ ¼
            SHA=$(echo "$SHA" | xargs)
            echo "ğŸ’ Cherry-picking: $SHA"
            
            if git cherry-pick "$SHA" --no-commit; then
              # è·å–åŸå§‹ commit ä¿¡æ¯
              COMMIT_MSG=$(git log -1 --format="%s" "$SHA" 2>/dev/null || echo "Cherry-picked $SHA")
              CHERRY_PICKED="${CHERRY_PICKED}- ${COMMIT_MSG} (\`${SHA:0:7}\`)\n"
              echo "âœ… Successfully cherry-picked: $SHA"
            else
              echo "âŒ Failed to cherry-pick: $SHA"
              git cherry-pick --abort 2>/dev/null || true
              exit 1
            fi
          done
          
          # Commit all cherry-picked changes
          git commit -m "chore: cherry-pick commits for ${TARGET_BRANCH#desktop/}"
          
          # Push the branch
          git push origin "$FEATURE_BRANCH"
          
          echo "feature_branch=$FEATURE_BRANCH" >> $GITHUB_OUTPUT
          echo "cherry_picked<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHERRY_PICKED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Branch pushed: $FEATURE_BRANCH"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.cherry-pick.outputs.feature_branch }}
          base: ${{ github.ref_name }}
          title: "ğŸ’ Cherry-pick to ${{ github.ref_name }}"
          body: |
            ## Cherry-picked Commits
            
            ${{ steps.cherry-pick.outputs.cherry_picked }}
            
            ---
            
            **Target Branch:** `${{ github.ref_name }}`
            **Requested By:** @${{ github.actor }}
            
            _Auto-generated by Cherry-pick workflow_
          delete-branch: true

      - name: Summary
        run: |
          echo "## ğŸ’ Cherry Pick Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Target Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Feature Branch | \`${{ steps.cherry-pick.outputs.feature_branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commits | \`${{ inputs.commit_shas }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| PR | #${{ steps.create-pr.outputs.pull-request-number }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cherry-picked:" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.cherry-pick.outputs.cherry_picked }}" >> $GITHUB_STEP_SUMMARY

  notify-slack:
    name: Notify Slack
    needs: cherry-pick
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        run: |
          cat > /tmp/slack_payload.json << 'EOF'
          {
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ğŸ’ *Cherry-pick Complete*\n\nCommits have been cherry-picked to \`${{ github.ref_name }}\`\n\n*Commits:* \`${{ inputs.commit_shas }}\`\n*By:* ${{ github.actor }}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View PR",
                      "emoji": true
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/pulls"
                  }
                ]
              }
            ]
          }
          EOF
          
          curl -X POST -H 'Content-type: application/json' \
            --data @/tmp/slack_payload.json \
            ${{ secrets.SLACK_WEBHOOK_URL }}

